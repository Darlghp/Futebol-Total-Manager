<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futebol Total - Manager Pro 9.5: Sob Press√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Estilo customizado para melhor visualiza√ß√£o */
        body { font-family: 'Inter', sans-serif; }
        .stat-bar { height: 8px; border-radius: 4px; transition: width 0.3s ease-in-out; }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .promotion { background-color: #d1fae5; border-left: 4px solid #10b981; } /* Verde para promo√ß√£o */
        .playoff { background-color: #FEF9C3; border-left: 4px solid #FACC15; } /* Amarelo para playoff */
        .relegation { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* Vermelho para rebaixamento */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .seu-time-playoff {
            border: 2px solid #4f46e5;
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="p-4 sm:p-8 max-w-7xl mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700">Futebol Total Manager Pro 9.5</h1>
            <p class="text-gray-500 text-lg">
                Temporada: <span id="season-counter" class="font-bold text-indigo-600">1</span> | 
                Divis√£o: <span id="division-name" class="font-bold text-gray-500">S√©rie F</span>
            </p>
        </header>

        <div class="bg-white p-6 rounded-xl card-shadow mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Seu Time: <span class="text-indigo-600" id="team-name"></span></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-start">
                <div class="flex flex-col space-y-2">
                    <p class="text-2xl font-bold text-green-600" id="team-balance"></p>
                    <p class="text-lg font-medium text-purple-600" id="team-sponsorship"></p>
                    <p class="text-lg font-medium text-red-600" id="team-salary"></p>
                </div>
                
                <div class="md:col-span-2 space-y-3">
                    <p class="text-lg font-medium text-gray-700" id="team-force"></p>
                    <div>
                        <label for="tatica-select" class="block text-sm font-medium text-gray-700 mb-1">Escolher T√°tica:</label>
                        <select id="tatica-select" onchange="alterarTatica(this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="Equilibrada">Equilibrada</option>
                            <option value="Ataque">Ataque (+5% For√ßa)</option>
                            <option value="Defesa">Defesa (-5% For√ßa)</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-col space-y-3 justify-end">
                    <button id="btn-train" onclick="treinar()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105 w-full">
                        Treinar Elenco
                    </button>
                    <button id="btn-match" onclick="jogarRodada()" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 transform hover:scale-105 w-full">
                        Jogar Rodada <span id="rodada-counter" class="font-bold">0</span>/38
                    </button>
                </div>
            </div>
            
            <div id="match-result" class="mt-4 p-3 rounded-lg text-center font-semibold hidden"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-xl card-shadow overflow-x-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="league-title">Classifica√ß√£o</h2>
                     <div class="flex items-center gap-2">
                        <button onclick="mostrarTrofeus()" class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm font-semibold rounded-lg hover:bg-yellow-200">
                            Sala de Trof√©us
                        </button>
                        <button onclick="mostrarHistorico()" class="px-3 py-1 bg-indigo-100 text-indigo-700 text-sm font-semibold rounded-lg hover:bg-indigo-200">
                            Hist√≥rico
                        </button>
                    </div>
                </div>
                <div id="league-table"></div>
                <div id="league-legend" class="mt-4 text-xs text-gray-500 space-y-1"></div>
            </div>
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Mercado de Transfer√™ncias</h2>
                        <button onclick="gerarNovoMercado()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300">
                            Atualizar
                        </button>
                    </div>
                    <div id="transfer-market-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Mercado de Empr√©stimos</h2>
                        <button onclick="gerarMercadoEmprestimo()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300">
                           Atualizar
                        </button>
                    </div>
                    <div id="loan-market-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl card-shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Estrutura do Clube</h2>
                <div class="space-y-4">
                    <div id="stadium-info"></div>
                    <div id="academia-info" class="mt-4"></div>
                    <div id="treinamento-info" class="mt-4"></div>
                    <div id="medico-info" class="mt-4"></div>
                    <div id="marketing-info" class="mt-4"></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl card-shadow">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4">Painel do Clube</h2>
                 <div id="fan-pressure-area" class="mb-4">
                     <h3 class="font-bold text-lg text-gray-700">Press√£o da Torcida</h3>
                     <div class="w-full bg-gray-200 rounded-full mt-1"><div id="fan-pressure-bar" class="stat-bar" style="width: 20%;"></div></div>
                     <p id="fan-pressure-text" class="text-sm text-center mt-1 font-semibold"></p>
                 </div>
                 <div id="news-feed" class="space-y-3 text-center p-4 bg-gray-50 rounded-lg min-h-[100px] flex items-center justify-center mb-4">
                    <p class="text-gray-500">Nenhum evento importante na √∫ltima rodada.</p>
                 </div>
                 <div id="financial-summary">
                    <h3 class="font-bold text-lg text-gray-700">Resumo da Rodada</h3>
                    <p class="text-sm text-green-600">Receita de Ingressos: <span id="income-tickets">+$0</span></p>
                    <p class="text-sm text-gray-600">Receita/Despesa (a cada 6r): <span id="income-finance-cycle">+$0</span></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-xl card-shadow">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Elenco (<span id="elenco-size"></span> jogadores)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jogador</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hab. / Pot. / Idade</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fadiga/Moral</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="player-stats-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl card-shadow mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Configura√ß√µes do Jogo</h2>
            <div id="settings-area" class="flex items-center space-x-3">
                <input type="checkbox" id="toggle-press-conference" onchange="toggleColetiva(this.checked)" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label for="toggle-press-conference" class="text-sm font-medium text-gray-700">Participar de Coletivas de Imprensa</label>
            </div>
        </div>

        <div class="mt-8 flex justify-center items-center gap-4">
            <button onclick="salvarJogo()" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">Salvar Jogo</button>
            <button onclick="carregarJogo()" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150">Carregar Jogo</button>
        </div>

    </div>

    <div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 modal-backdrop" onclick="fecharHistorico()"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl z-10 m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Hist√≥rico do Clube</h2>
            <div id="history-content" class="max-h-96 overflow-y-auto"></div>
            <button onclick="fecharHistorico()" class="mt-6 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 w-full">Fechar</button>
        </div>
    </div>

    <div id="trophy-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 modal-backdrop" onclick="fecharTrofeus()"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl z-10 m-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Sala de Trof√©us</h2>
            <div id="trophy-content" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6"></div>
            <button onclick="fecharTrofeus()" class="mt-8 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 w-full">Fechar</button>
        </div>
    </div>

    <div id="playoff-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 modal-backdrop" onclick="fecharPlayoffModal()"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl z-10 m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Torneio de Promo√ß√£o - S√©rie F</h2>
            <div id="playoff-content" class="space-y-4 text-center"></div>
            <button onclick="fecharPlayoffModal()" class="mt-6 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 w-full">Fechar</button>
        </div>
    </div>

    <div id="press-conference-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg z-10 m-4">
            <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Coletiva de Imprensa</h2>
            <p class="text-center text-gray-600 mb-4">Como voc√™ avalia a partida?</p>
            <div id="press-conference-result" class="text-center text-xl font-bold mb-6"></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button onclick="responderColetiva('elogiar')" class="px-4 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">Elogiar Time</button>
                <button onclick="responderColetiva('criticar')" class="px-4 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Criticar Atua√ß√£o</button>
                <button onclick="responderColetiva('neutro')" class="px-4 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600">Resposta Neutra</button>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais do jogo
        let meuTime;
        let gameManager;
        let rodadaCount = 0;
        let temporadaCount = 1;
        let mercadoJogadores = [];
        let mercadoEmprestimo = [];
        let lastTicketIncome = 0;
        let lastFinanceCycleIncome = 0;
        let pendingMatchResult = null;
        let pressaoTorcida = 20;
        let configuracoes = {
            coletivaOpcional: true
        };
        const SAVE_KEY = 'futebolManagerSave_v9_5';

        // --- CONSTANTES ---
        const MAX_TITULARES = 11; 
        const TIMES_A_B = 10;
        const TIMES_C_D_E = 20;
        const TIMES_F = 20;
        const RODADAS_PARA_PAGAMENTO = 6;
        const TOTAL_TIMES = (TIMES_A_B * 2) + (TIMES_C_D_E * 3) + TIMES_F; 
        const PROMOTE_RELEGATE_ALTA = 2; 
        const PROMOTE_RELEGATE_BAIXA = 4; 
        const POSICOES = ["Goleiro", "Zagueiro", "Lateral", "Meio-campo", "Atacante"];
        const NOMES_BASE = ["Lucas", "Rafael", "Gabriel", "Mateus", "Bruno", "C√©sar", "Davi", "√âder", "F√°bio", "Gustavo", "Igor", "Jonas", "Alexandre", "Vitor", "Pedro", "Jo√£o"];
        const NOME_TIMES_IA = [
            "Independente de Limeira", "Nacional de Patos", "Atl√©tico Serrano", "Uni√£o de Mogi", "EC S√£o Jos√©", "Oper√°rio V√°rzea-grandense", "Comercial (MS)", "Porto de Caruaru", "Central de Patos", "Volta Redonda FC", "Ypiranga de Erechim", "Ferrovi√°rio de Fortaleza", "Botafogo de Ribeir√£o Preto", "Brusque FC", "Caxias do Sul", "Figueirense FC", "Londrina EC", "Novorizontino", "Paysandu SC", "Ponte Preta", "Remo", "Sampaio Corr√™a", "Tombense", "Vila Nova FC", "Amazonas FC", "Aparecidense", "Bragantino", "CRB", "CSA", "Crici√∫ma", "Goi√°s", "Guarani", "Ituano", "Juventude", "Mirassol", "N√°utico", "Oeste", "Paran√° Clube", "Santa Cruz", "Sport Recife", "Vit√≥ria", "Chapecoense", "Coritiba", "Cuiab√°", "Fortaleza", "Goi√°s", "Ava√≠", "Brasil de Pelotas", "Confian√ßa", "Cruzeiro", "Oper√°rio Ferrovi√°rio", "Vit√≥ria", "Am√©rica de Natal", "Campinense", "Floresta EC", "Jacuipense", "Manaus FC", "S√£o Bernardo", "Altos do Piau√≠", "S√£o Raimundo (AM)", "Tocantin√≥polis", "Sergipe", "Ceil√¢ndia", "Costa Rica (MS)", "Globo FC", "Icasa", "Lagarto FC", "Nova Ven√©cia", "Pouso Alegre", "Real Noroeste", "Retr√¥ FC Brasil", "Tuna Luso Brasileira", "Uni√£o Rondon√≥polis", "Afogados da Ingazeira", "√Åguia Negra", "Atl√©tico Acreano", "Bahia de Feira", "Bar√©", "Brasiliense", "Caldense", "Castanhal", "Cianorte", "Coruripe", "Fast Clube", "FC Cascavel", "Ferrovi√°ria", "Galvez", "Gama", "Goian√©sia", "Inter de Limeira", "Joinville", "Juazeirense", "Marc√≠lio Dias", "Mirassol", "Moto Club", "Murici", "Palmas", "Patrocinense", "Penarol", "Picos", "Rio Branco (AC)", "Rio Branco (ES)", "Salgueiro", "Santos (AP)", "S√£o Caetano", "Treze", "Tupi", "Uberl√¢ndia", "URT", "Villa Nova (MG)", "Ypiranga (AP)"
        ];
        
        const eventosAleatorios = [
            {
                titulo: "Moral em Alta!",
                desc: "Uma vit√≥ria inspiradora aumentou a moral de todo o elenco em +10.",
                efeito: (time) => time.jogadores.forEach(j => j.moral = Math.min(100, j.moral + 10))
            },
            {
                titulo: "Jovem Promessa Descoberta!",
                desc: "Um olheiro descobriu um jovem com potencial incr√≠vel. Ele se juntou ao time de gra√ßa!",
                efeito: (time) => {
                    const jovem = gerarJogador(60, 70, 90, 100, 17, 18);
                    time.jogadores.push(jovem);
                }
            },
            {
                titulo: "Pequena Crise Financeira",
                desc: "Despesas inesperadas reduziram o saldo do clube em $5,000.",
                efeito: (time) => time.saldo -= 5000
            },
            {
                titulo: "Patrocinador Satisfeito",
                desc: "Um patrocinador local, feliz com os resultados, injetou um b√¥nus de $10,000 no clube!",
                efeito: (time) => time.saldo += 10000
            },
            {
                titulo: "Fadiga Coletiva",
                desc: "Uma semana de treinos intensos deixou o elenco mais fadigado (+10 Fadiga para todos).",
                efeito: (time) => time.jogadores.forEach(j => j.fadiga = Math.min(100, j.fadiga + 10))
            },
            { 
                titulo: "Crise Econ√¥mica Afeta o Clube!",
                desc: "Uma crise global impactou os patrocinadores, resultando em uma perda de 20% do seu saldo atual.",
                efeito: (time) => time.saldo = Math.floor(time.saldo * 0.8)
            }
        ];

        class Jogador {
            constructor(nome, posicao, habilidade, resistencia, moral, idade, potencial) {
                this.id = crypto.randomUUID();
                this.nome = nome; this.posicao = posicao; this.habilidade = habilidade;
                this.resistencia = resistencia; this.moral = moral; this.idade = idade; 
                this.potencial = potencial; this.fadiga = 0; this.quimica = 50;
                this.lesionado = false; this.dias_recuperacao = 0;
                this.emprestado = false;
            }
            treinar(isTitular, centroTreinamentoNivel = 1, deptoMedicoNivel = 1) {
                if (this.lesionado) return;
                if (this.habilidade < this.potencial) {
                    const fatorTitular = isTitular ? 1.5 : 1.0;
                    const fatorCT = 1 + (centroTreinamentoNivel - 1) * 0.1;
                    let incremento = (Math.floor(Math.random() * 2) + 1) * fatorCT; 
                    let moralMultiplier = 1.0;
                    if (this.moral > 75) moralMultiplier = 1.5; 
                    else if (this.moral < 40) moralMultiplier = 0.5; 
                    incremento *= moralMultiplier;
                    if (this.idade >= 30) incremento *= 0.5;
                    if (this.idade >= 35) incremento *= 0.1;
                    this.habilidade = Math.min(this.potencial, this.habilidade + Math.floor(incremento * fatorTitular));
                }
                this.fadiga = Math.min(100, this.fadiga + Math.floor(15 * (isTitular ? 1.5 : 1.0)));
                this.moral = Math.min(100, this.moral + 2);
                this.quimica = Math.min(100, this.quimica + 3);
                
                let chanceLesao = 0.05 + (this.fadiga / 100) * 0.05;
                if (Math.random() < chanceLesao) {
                    this.lesionado = true;
                    const fatorDM = 1 - (deptoMedicoNivel - 1) * 0.1; // Reduz em 10% por n√≠vel
                    this.dias_recuperacao = Math.max(1, Math.floor((Math.floor(Math.random() * 5) + 3) * fatorDM)); 
                }
            }
            envelhecer() {
                this.idade += 1;
                if (this.idade > 30) {
                    const decay = Math.floor(Math.random() * (this.idade - 28)); 
                    this.habilidade = Math.max(50, this.habilidade - decay);
                    if (this.idade > 35) this.potencial = Math.max(this.habilidade, this.potencial - 2);
                }
            }
            recuperar(isTitular) {
                const fatorRecuperacao = isTitular ? 10 : 20; 
                this.fadiga = Math.max(0, this.fadiga - fatorRecuperacao);
                if (this.lesionado) {
                    this.dias_recuperacao -= 1;
                    if (this.dias_recuperacao <= 0) this.lesionado = false;
                }
            }
        }

        class Time {
            constructor(nome, saldo, eh_jogador = false, divisao = 'F') {
                this.id = crypto.randomUUID(); 
                this.nome = nome; this.saldo = saldo; this.jogadores = []; 
                this.titulares = [];
                this.tatica = "Equilibrada";
                this.vitorias = 0; this.empates = 0; this.derrotas = 0;
                this.pontos = 0; this.gols_pro = 0; this.gols_contra = 0;
                this.eh_jogador = eh_jogador; this.patrocinio_valor = 0; this.divisao = divisao;
                this.estadio_nivel = 1; this.estadio_capacidade = 5000; this.historico = [];
                this.academia_nivel = 1; 
                this.centro_treinamento_nivel = 1;
                this.depto_medico_nivel = 1;
                this.depto_marketing_nivel = 1;
                this.trofeus = {};
            }
            getJogador(id) { return this.jogadores.find(j => j.id === id); }
            contratar(jogador) {
                const custo = Math.floor(jogador.habilidade * 75 * (1 + jogador.idade / 50));
                if (this.saldo >= custo) {
                    this.jogadores.push(jogador); this.saldo -= custo;
                    if (this.titulares.length < MAX_TITULARES) this.titulares.push(jogador.id);
                    return { success: true, custo };
                }
                return { success: false, custo };
            }
            venderJogador(jogadorId) {
                const jogador = this.getJogador(jogadorId);
                const index = this.jogadores.indexOf(jogador);
                if (index > -1) {
                    const reputationMultiplier = { 'A': 1.0, 'B': 0.85, 'C': 0.65, 'D': 0.5, 'E': 0.40, 'F': 0.30 }[this.divisao];
                    const basePrice = Math.floor(jogador.habilidade * 15 * (1 + jogador.potencial / 100) * (1 - jogador.idade / 50)); 
                    const precoVenda = Math.floor(basePrice * reputationMultiplier);
                    
                    this.saldo += precoVenda; this.jogadores.splice(index, 1);
                    this.titulares = this.titulares.filter(id => id !== jogador.id);
                    return { success: true, preco: precoVenda };
                }
                return { success: false };
            }
            moverParaTitular(jogadorId) {
                if (this.titulares.length >= MAX_TITULARES || this.titulares.includes(jogadorId)) return false;
                this.titulares.push(jogadorId); return true;
            }
            moverParaReserva(jogadorId) { this.titulares = this.titulares.filter(id => id !== jogadorId); }
            treinarElenco() { this.jogadores.forEach(j => j.treinar(this.titulares.includes(j.id), this.centro_treinamento_nivel, this.depto_medico_nivel)); }
            setTatica(novaTatica) { this.tatica = novaTatica; }
            calcularFolhaSalarial() { 
                return this.jogadores.reduce((total, j) => total + (j.habilidade * 10), 0);
            }
            receberPatrocinioESalarios() {
                const folha = this.calcularFolhaSalarial();
                const patrocinio = this.eh_jogador ? this.patrocinio_valor : 1000 + gameManager.divisoes[this.divisao].media_forca_ia * 10; 
                this.saldo += patrocinio - folha;
                lastFinanceCycleIncome = patrocinio - folha;
            }
            pagarBonusVitoria() {
                const mediaHab = this.jogadores.reduce((sum, j) => sum + j.habilidade, 0) / this.jogadores.length;
                const bonus = Math.floor(mediaHab * 20); 
                this.saldo -= bonus; return bonus;
            }
            atualizarPatrocinio(posicaoNaTabela) {
                let basePatrocinio = { 'A': 40000, 'B': 20000, 'C': 7500, 'D': 2500, 'E': 1500, 'F': 1000 }[this.divisao] || 1000;
                let performanceMultiplier = 1.0; 
                const promoteCount = { 'A': 1, 'B': PROMOTE_RELEGATE_ALTA, 'C': PROMOTE_RELEGATE_ALTA, 'D': PROMOTE_RELEGATE_BAIXA, 'E': PROMOTE_RELEGATE_BAIXA, 'F': 2 }[this.divisao];
                if (posicaoNaTabela <= promoteCount) performanceMultiplier = 1.25;
                if (posicaoNaTabela === 1) performanceMultiplier = 1.4; // B√¥nus de campe√£o
                const mediaHab = this.jogadores.reduce((sum, j) => sum + j.habilidade, 0) / (this.jogadores.length || 1);
                const prestigioBonus = Math.max(0, (mediaHab - 50) * 20); 
                const bonusAnual = (temporadaCount - 1) * 2000; 
                this.patrocinio_valor = Math.floor(basePatrocinio * performanceMultiplier + prestigioBonus + bonusAnual);
            }
            curarJogador(jogadorId) {
                const jogador = this.getJogador(jogadorId);
                const custo = jogador.habilidade * 100;
                if (jogador && jogador.lesionado && this.saldo >= custo) {
                    this.saldo -= custo; jogador.lesionado = false; jogador.dias_recuperacao = 0;
                    return { success: true, custo };
                }
                return { success: false, custo };
            }
            melhorarEstadio() {
                const custo = this.estadio_nivel * 75000 * (1 + (this.estadio_nivel / 5));
                if (this.saldo >= custo) {
                    this.saldo -= custo; this.estadio_nivel++;
                    this.estadio_capacidade = 5000 + (this.estadio_nivel - 1) * 2500;
                    return { success: true, custo };
                }
                return { success: false, custo };
            }
            calcularForca() {
                let forca = 0, jogadoresDisponiveis = 0;
                const jogadoresTitulares = this.titulares.map(id => this.getJogador(id)).filter(j => j && !j.lesionado);
                for (const j of jogadoresTitulares) {
                    forca += j.habilidade + (j.moral / 2) + (j.quimica / 3) + (j.resistencia / 4) - j.fadiga;
                    jogadoresDisponiveis++;
                }
                if (jogadoresDisponiveis < MAX_TITULARES) forca -= (MAX_TITULARES - jogadoresDisponiveis) * 30;
                if (jogadoresDisponiveis === 0) return 1;
                let forcaMedia = forca / MAX_TITULARES;
                if (this.tatica === "Ataque") forcaMedia *= 1.05;
                else if (this.tatica === "Defesa") forcaMedia *= 0.95;
                if (!this.eh_jogador) forcaMedia += (gameManager.divisoes[this.divisao].media_forca_ia - 60) * 0.5;
                return Math.max(1, forcaMedia);
            }
            atualizarRecuperacao() { this.jogadores.forEach(j => j.recuperar(this.titulares.includes(j.id))); }
            calcularPontos() { return this.vitorias * 3 + this.empates; }
        }

        class Divisao {
            constructor(nome, times, promoteCount, relegatCount, size) {
                this.nome = nome; this.times = times; this.promoteCount = promoteCount;
                this.relegatCount = relegatCount; this.size = size; this.media_forca_ia = 60; 
            }
            rodada() {
                const timesDisponiveis = [...this.times];
                timesDisponiveis.sort(() => Math.random() - 0.5); 
                const resultados = [];
                while(timesDisponiveis.length >= 2) {
                    const time1 = timesDisponiveis.pop();
                    const time2 = timesDisponiveis.pop();
                    resultados.push(this.simularPartida(time1, time2));
                }
                for (const t of this.times) {
                    if (t.jogadores.length > 0) {
                        t.titulares.map(id => t.getJogador(id)).filter(Boolean).forEach(j => j.fadiga = Math.min(100, j.fadiga + 25));
                    }
                    t.atualizarRecuperacao();
                }
                return resultados;
            }
            simularPartida(time1, time2) {
                const f1 = time1.calcularForca(), f2 = time2.calcularForca();
                const gols1 = Math.max(0, Math.floor(f1 / 50 + Math.random() * 3));
                const gols2 = Math.max(0, Math.floor(f2 / 50 + Math.random() * 3));
                time1.gols_pro += gols1; time1.gols_contra += gols2;
                time2.gols_pro += gols2; time2.gols_contra += gols1;
                if (gols1 > gols2) { time1.vitorias++; time2.derrotas++; }
                else if (gols2 > gols1) { time2.vitorias++; time1.derrotas++; }
                else { time1.empates++; time2.empates++; }
                time1.pontos = time1.calcularPontos(); time2.pontos = time2.calcularPontos();
                return { 
                    time1: time1.nome, time1_id: time1.id, gols1, 
                    time2: time2.nome, time2_id: time2.id, gols2 
                };
            }
            getTabelaClassificacao() {
                return this.times.sort((a, b) => b.pontos - a.pontos || (b.gols_pro - b.gols_contra) - (a.gols_pro - a.gols_contra) || b.gols_pro - a.gols_pro);
            }
        }

        function gerarJogador(habMin, habMax, potMin, potMax, idadeMin, idadeMax) {
            const nome = NOMES_BASE[Math.floor(Math.random() * NOMES_BASE.length)] + ' ' + (Math.floor(Math.random() * 900) + 100);
            const posicao = POSICOES[Math.floor(Math.random() * POSICOES.length)];
            const idade = Math.floor(Math.random() * (idadeMax - idadeMin + 1)) + idadeMin;
            const potencial = Math.floor(Math.random() * (potMax - potMin + 1)) + potMin;
            const habilidade = Math.min(Math.floor(Math.random() * (habMax - habMin + 1)) + habMin, potencial);
            const resistencia = Math.floor(Math.random() * 31) + 60; 
            const moral = Math.floor(Math.random() * 21) + 60; 
            return new Jogador(nome, posicao, habilidade, resistencia, moral, idade, potencial);
        }
        
        function gerarNovoMercado() {
            mercadoJogadores = [];
            for (let i = 0; i < 8; i++) {
                mercadoJogadores.push(gerarJogador(65, 95, 75, 100, 20, 30));
            }
            atualizarGraficos();
        }

        function gerarMercadoEmprestimo() {
            mercadoEmprestimo = [];
            for (let i = 0; i < 8; i++) {
                mercadoEmprestimo.push(gerarJogador(70, 85, 75, 90, 24, 32));
            }
            atualizarGraficos();
        }

        function initGame() {
            meuTime = new Time("Meu Clube FC", 30000, true, 'F');
            let nomesIA = [...NOME_TIMES_IA];
            nomesIA.sort(() => Math.random() - 0.5);
            const todosOsTimes = [meuTime];
            for (let i = 0; i < TOTAL_TIMES - 1; i++) {
                 const nomeTime = nomesIA[i] || `Clube Gen√©rico ${i + 1}`;
                 todosOsTimes.push(new Time(nomeTime, 3000));
            }

            let teamsA = [], teamsB = [], teamsC = [], teamsD = [], teamsE = [], teamsF = [];
            for (const t of todosOsTimes) {
                let currentDiv = 'F'; 
                if (!t.eh_jogador) {
                    if (teamsA.length < TIMES_A_B) currentDiv = 'A';
                    else if (teamsB.length < TIMES_A_B) currentDiv = 'B';
                    else if (teamsC.length < TIMES_C_D_E) currentDiv = 'C';
                    else if (teamsD.length < TIMES_C_D_E) currentDiv = 'D';
                    else if (teamsE.length < TIMES_C_D_E) currentDiv = 'E';
                    else currentDiv = 'F';
                    t.divisao = currentDiv;
                } else {
                    currentDiv = t.divisao;
                }
                
                if (currentDiv === 'A') teamsA.push(t);
                else if (currentDiv === 'B') teamsB.push(t);
                else if (currentDiv === 'C') teamsC.push(t);
                else if (currentDiv === 'D') teamsD.push(t);
                else if (currentDiv === 'E') teamsE.push(t);
                else if (currentDiv === 'F') teamsF.push(t);

                const habRanges = { 'A': [75, 95, 85, 100], 'B': [60, 85, 75, 95], 'C': [45, 75, 65, 90], 'D': [30, 60, 50, 80], 'E': [20, 45, 40, 75], 'F': [15, 35, 30, 70] };
                const [habMin, habMax, potMin, potMax] = habRanges[currentDiv];
                
                const initialPlayers = t.eh_jogador ? 18 : 15;
                for (let i = 0; i < initialPlayers; i++) {
                    const initialPlayer = gerarJogador(habMin, habMax, potMin, potMax, 18, 25);
                    const custo = Math.floor(initialPlayer.habilidade * 10);
                    if (t.saldo >= custo) {
                        t.jogadores.push(initialPlayer);
                        t.saldo -= custo;
                    }
                }
                t.jogadores.sort((a, b) => b.habilidade - a.habilidade);
                t.titulares = t.jogadores.slice(0, MAX_TITULARES).map(j => j.id);
            }
            
            gameManager = {
                meuTime: meuTime,
                divisoes: {
                    'A': new Divisao("S√©rie A", teamsA, 0, PROMOTE_RELEGATE_ALTA, TIMES_A_B),
                    'B': new Divisao("S√©rie B", teamsB, PROMOTE_RELEGATE_ALTA, PROMOTE_RELEGATE_ALTA, TIMES_A_B),
                    'C': new Divisao("S√©rie C", teamsC, PROMOTE_RELEGATE_ALTA, PROMOTE_RELEGATE_BAIXA, TIMES_C_D_E),
                    'D': new Divisao("S√©rie D", teamsD, PROMOTE_RELEGATE_BAIXA, PROMOTE_RELEGATE_BAIXA, TIMES_C_D_E),
                    'E': new Divisao("S√©rie E", teamsE, PROMOTE_RELEGATE_BAIXA, PROMOTE_RELEGATE_BAIXA, TIMES_C_D_E),
                    'F': new Divisao("S√©rie F", teamsF, 2, 0, TIMES_F) // promoteCount = 2 (1 direto + 1 playoff)
                }
            };
            
            gameManager.divisoes['A'].media_forca_ia = 85; gameManager.divisoes['B'].media_forca_ia = 70;
            gameManager.divisoes['C'].media_forca_ia = 55; gameManager.divisoes['D'].media_forca_ia = 40;
            gameManager.divisoes['E'].media_forca_ia = 25;
            gameManager.divisoes['F'].media_forca_ia = 15;

            meuTime.atualizarPatrocinio(TIMES_F / 2); 
            document.getElementById('team-name').textContent = meuTime.nome;
            document.getElementById('toggle-press-conference').checked = configuracoes.coletivaOpcional;
            gerarNovoMercado();
            gerarMercadoEmprestimo();
            atualizarGraficos();
        }
        
        function treinar() {
            meuTime.treinarElenco();
            atualizarGraficos();
            exibirMensagem("Treinamento conclu√≠do. O moral dos jogadores influenciou a evolu√ß√£o.", "info");
        }

        function curarJogadorImediatamente(jogadorId) {
            const jogador = meuTime.getJogador(jogadorId);
            if (!jogador || !jogador.lesionado) return;
            const resultado = meuTime.curarJogador(jogadorId);
            if (resultado.success) {
                atualizarGraficos();
                exibirMensagem(`${jogador.nome} curado por $${resultado.custo.toLocaleString('pt-BR')}!`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente! Custo: $${resultado.custo.toLocaleString('pt-BR')}.`, "error");
            }
        }

        function alterarTatica(novaTatica) {
            meuTime.setTatica(novaTatica);
            atualizarGraficos();
        }

        function contratarJogador(index) {
            const jogador = mercadoJogadores[index];
            if (!jogador) return;
            const resultado = meuTime.contratar(jogador);
            if (resultado.success) {
                mercadoJogadores.splice(index, 1); 
                atualizarGraficos();
                exibirMensagem(`${jogador.nome} contratado por $${resultado.custo.toLocaleString('pt-BR')}.`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente! Custo: $${resultado.custo.toLocaleString('pt-BR')}.`, "error");
            }
        }
        
        function emprestarJogador(index) {
            const jogador = mercadoEmprestimo[index];
            if (!jogador) return;
            const custo = Math.floor(jogador.habilidade * 250 * (1 - (jogador.idade - 24) * 0.05));
            if (meuTime.saldo >= custo) {
                meuTime.saldo -= custo;
                jogador.emprestado = true;
                meuTime.jogadores.push(jogador);
                mercadoEmprestimo.splice(index, 1);
                atualizarGraficos();
                exibirMensagem(`${jogador.nome} chega por empr√©stimo! Custo: $${custo.toLocaleString('pt-BR')}.`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente para a taxa de empr√©stimo! Custo: $${custo.toLocaleString('pt-BR')}.`, "error");
            }
        }

        function venderJogador(jogadorId) {
            const jogador = meuTime.getJogador(jogadorId);
            if (!jogador) return;
            if (jogador.emprestado) {
                exibirMensagem("Voc√™ n√£o pode vender um jogador emprestado!", "error");
                return;
            }
            const resultado = meuTime.venderJogador(jogadorId);
            if (resultado.success) {
                atualizarGraficos();
                exibirMensagem(`${jogador.nome} vendido por $${resultado.preco.toLocaleString('pt-BR')}.`, "warning");
            }
        }
        
        function toggleTitularidade(jogadorId, isTitular) {
            if (isTitular) {
                meuTime.moverParaReserva(jogadorId);
            } else {
                if (!meuTime.moverParaTitular(jogadorId)) {
                    exibirMensagem(`Voc√™ j√° tem ${MAX_TITULARES} titulares.`, "error");
                }
            }
            atualizarGraficos();
        }

        function upgradeEstadio() {
            const resultado = meuTime.melhorarEstadio();
            if (resultado.success) {
                atualizarGraficos();
                exibirMensagem(`Est√°dio melhorado para o N√≠vel ${meuTime.estadio_nivel} por $${resultado.custo.toLocaleString('pt-BR')}!`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente para melhorar o est√°dio! Custo: $${resultado.custo.toLocaleString('pt-BR')}`, "error");
            }
        }

        function melhorarAcademia() {
            const custo = Math.floor(100000 * Math.pow(1.5, meuTime.academia_nivel - 1));
            if (meuTime.saldo >= custo) {
                meuTime.saldo -= custo;
                meuTime.academia_nivel++;
                atualizarGraficos();
                exibirMensagem(`Academia melhorada para o N√≠vel ${meuTime.academia_nivel} por $${custo.toLocaleString('pt-BR')}!`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente! Custo: $${custo.toLocaleString('pt-BR')}`, "error");
            }
        }

        function melhorarCentroTreinamento() {
            const custo = Math.floor(120000 * Math.pow(1.6, meuTime.centro_treinamento_nivel - 1));
            if (meuTime.saldo >= custo) {
                meuTime.saldo -= custo;
                meuTime.centro_treinamento_nivel++;
                atualizarGraficos();
                exibirMensagem(`Centro de Treinamento melhorado para o N√≠vel ${meuTime.centro_treinamento_nivel} por $${custo.toLocaleString('pt-BR')}!`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente! Custo: $${custo.toLocaleString('pt-BR')}`, "error");
            }
        }

        function melhorarDeptoMedico() {
            const custo = Math.floor(150000 * Math.pow(1.5, meuTime.depto_medico_nivel - 1));
            if (meuTime.saldo >= custo) {
                meuTime.saldo -= custo;
                meuTime.depto_medico_nivel++;
                atualizarGraficos();
                exibirMensagem(`Departamento M√©dico melhorado para o N√≠vel ${meuTime.depto_medico_nivel} por $${custo.toLocaleString('pt-BR')}!`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente! Custo: $${custo.toLocaleString('pt-BR')}`, "error");
            }
        }
        
        function melhorarDeptoMarketing() {
            const custo = Math.floor(80000 * Math.pow(1.7, meuTime.depto_marketing_nivel - 1));
            if (meuTime.saldo >= custo) {
                meuTime.saldo -= custo;
                meuTime.depto_marketing_nivel++;
                atualizarGraficos();
                exibirMensagem(`Depto. de Marketing melhorado para o N√≠vel ${meuTime.depto_marketing_nivel} por $${custo.toLocaleString('pt-BR')}!`, "success");
            } else {
                exibirMensagem(`Saldo insuficiente! Custo: $${custo.toLocaleString('pt-BR')}`, "error");
            }
        }

        function simularPartidaSimples(time1, time2) {
            const f1 = time1.calcularForca(), f2 = time2.calcularForca();
            let gols1 = 0, gols2 = 0;
            do {
                gols1 = Math.max(0, Math.floor(f1 / 40 + Math.random() * 4));
                gols2 = Math.max(0, Math.floor(f2 / 40 + Math.random() * 4));
            } while (gols1 === gols2);
            const vencedor = gols1 > gols2 ? time1 : time2;
            const perdedor = gols1 < gols2 ? time1 : time2;
            return { vencedor, perdedor, golsVencedor: Math.max(gols1, gols2), golsPerdedor: Math.min(gols1, gols2) };
        }

        function simularPlayoffSerieF(timesDoPlayoff) {
            let log = `<div class="space-y-3">`;
            const [time2, time3, time4, time5, time6] = timesDoPlayoff;

            const res1 = simularPartidaSimples(time6, time5);
            const classeDestaque1 = (res1.vencedor.eh_jogador || res1.perdedor.eh_jogador) ? 'seu-time-playoff' : 'bg-gray-100';
            log += `<div class="p-2 ${classeDestaque1} rounded"><b>1¬™ Fase:</b> ${res1.vencedor.nome} <b class="text-green-600">${res1.golsVencedor}</b> x <b>${res1.golsPerdedor}</b> ${res1.perdedor.nome}</div>`;
            const v1 = res1.vencedor;

            const res2 = simularPartidaSimples(v1, time4);
            const classeDestaque2 = (res2.vencedor.eh_jogador || res2.perdedor.eh_jogador) ? 'seu-time-playoff' : 'bg-gray-100';
            log += `<div class="p-2 ${classeDestaque2} rounded"><b>2¬™ Fase:</b> ${res2.vencedor.nome} <b class="text-green-600">${res2.golsVencedor}</b> x <b>${res2.golsPerdedor}</b> ${res2.perdedor.nome}</div>`;
            const v2 = res2.vencedor;
            
            const res3 = simularPartidaSimples(v2, time3);
            const classeDestaque3 = (res3.vencedor.eh_jogador || res3.perdedor.eh_jogador) ? 'seu-time-playoff' : 'bg-gray-100';
            log += `<div class="p-2 ${classeDestaque3} rounded"><b>Semifinal:</b> ${res3.vencedor.nome} <b class="text-green-600">${res3.golsVencedor}</b> x <b>${res3.golsPerdedor}</b> ${res3.perdedor.nome}</div>`;
            const v3 = res3.vencedor;
            
            const resFinal = simularPartidaSimples(v3, time2);
            const classeDestaqueFinal = (resFinal.vencedor.eh_jogador || resFinal.perdedor.eh_jogador) ? 'seu-time-playoff' : 'bg-yellow-100';
            log += `<div class="p-2 ${classeDestaqueFinal} rounded"><b>Final:</b> ${resFinal.vencedor.nome} <b class="text-green-600">${resFinal.golsVencedor}</b> x <b>${resFinal.golsPerdedor}</b> ${resFinal.perdedor.nome}</div>`;
            log += `</div><div class="mt-4 p-3 bg-green-100 text-green-800 font-bold rounded">üèÜ ${resFinal.vencedor.nome} sobe para a S√©rie E!</div>`;
            
            return { vencedor: resFinal.vencedor, log: log };
        }

        function promoverRebaixar() {
            const { A: serieA, B: serieB, C: serieC, D: serieD, E: serieE, F: serieF } = gameManager.divisoes;
            const tabelaA = serieA.getTabelaClassificacao(), tabelaB = serieB.getTabelaClassificacao();
            const tabelaC = serieC.getTabelaClassificacao(), tabelaD = serieD.getTabelaClassificacao();
            const tabelaE = serieE.getTabelaClassificacao(), tabelaF = serieF.getTabelaClassificacao();

            const rebaixadosAtoB = tabelaA.slice(-PROMOTE_RELEGATE_ALTA), promovidosBtoA = tabelaB.slice(0, PROMOTE_RELEGATE_ALTA);
            const rebaixadosBtoC = tabelaB.slice(-PROMOTE_RELEGATE_ALTA), promovidosCtoB = tabelaC.slice(0, PROMOTE_RELEGATE_ALTA);
            const rebaixadosCtoD = tabelaC.slice(-PROMOTE_RELEGATE_BAIXA), promovidosDtoC = tabelaD.slice(0, PROMOTE_RELEGATE_BAIXA);
            const rebaixadosDtoE = tabelaD.slice(-PROMOTE_RELEGATE_BAIXA), promovidosEtoD = tabelaE.slice(0, PROMOTE_RELEGATE_BAIXA);
            const rebaixadosEtoF = tabelaE.slice(-PROMOTE_RELEGATE_BAIXA);
            
            let playoffResult = null;
            let promovidosFtoE = [];
            if (tabelaF.length > 5) {
                const campeaoF = tabelaF[0];
                const timesDoPlayoffF = tabelaF.slice(1, 6);
                playoffResult = simularPlayoffSerieF(timesDoPlayoffF);
                const promovidoPlayoffF = playoffResult.vencedor;
                promovidosFtoE = [campeaoF, promovidoPlayoffF];
            } else {
                promovidosFtoE = tabelaF.slice(0, 2); 
            }

            const novosSerieA = [...tabelaA.slice(0, TIMES_A_B - PROMOTE_RELEGATE_ALTA), ...promovidosBtoA];
            const novosSerieB = [...tabelaB.slice(PROMOTE_RELEGATE_ALTA, TIMES_A_B - PROMOTE_RELEGATE_ALTA), ...rebaixadosAtoB, ...promovidosCtoB];
            const novosSerieC = [...tabelaC.slice(PROMOTE_RELEGATE_ALTA, TIMES_C_D_E - PROMOTE_RELEGATE_BAIXA), ...rebaixadosBtoC, ...promovidosDtoC];
            const novosSerieD = [...tabelaD.slice(PROMOTE_RELEGATE_BAIXA, TIMES_C_D_E - PROMOTE_RELEGATE_BAIXA), ...rebaixadosCtoD, ...promovidosEtoD];
            const novosSerieE = [...tabelaE.slice(PROMOTE_RELEGATE_BAIXA, TIMES_C_D_E - PROMOTE_RELEGATE_BAIXA), ...rebaixadosDtoE, ...promovidosFtoE];
            const novosSerieF = [...tabelaF.filter(t => !promovidosFtoE.includes(t)), ...rebaixadosEtoF];

            novosSerieA.forEach(t => t.divisao = 'A'); serieA.times = novosSerieA;
            novosSerieB.forEach(t => t.divisao = 'B'); serieB.times = novosSerieB;
            novosSerieC.forEach(t => t.divisao = 'C'); serieC.times = novosSerieC;
            novosSerieD.forEach(t => t.divisao = 'D'); serieD.times = novosSerieD;
            novosSerieE.forEach(t => t.divisao = 'E'); serieE.times = novosSerieE;
            novosSerieF.forEach(t => t.divisao = 'F'); serieF.times = novosSerieF;
            
            let resultadoFinal = "", divisaoAnterior = meuTime.divisao;
            let campeao = false;

            const tabelasAnteriores = {A:tabelaA, B:tabelaB, C:tabelaC, D:tabelaD, E:tabelaE, F:tabelaF};
            const tabelaFinalDivisaoAnterior = tabelasAnteriores[divisaoAnterior];
            const posicaoFinalAnterior = tabelaFinalDivisaoAnterior.findIndex(t => t.id === meuTime.id) + 1;

            if(posicaoFinalAnterior === 1) {
                campeao = true;
                if (!meuTime.trofeus) meuTime.trofeus = {};
                if (!meuTime.trofeus[divisaoAnterior]) {
                    meuTime.trofeus[divisaoAnterior] = [];
                }
                meuTime.trofeus[divisaoAnterior].push(temporadaCount);
            }

            if (promovidosFtoE.some(t => t.id === meuTime.id)) { resultadoFinal = "PROMO√á√ÉO! Voc√™ subiu para a S√©rie E!"; }
            else if (rebaixadosEtoF.some(t => t.id === meuTime.id)) { resultadoFinal = "REBAIXAMENTO! Voc√™ caiu para a S√©rie F."; }
            else if (promovidosEtoD.some(t => t.id === meuTime.id)) { resultadoFinal = "PROMO√á√ÉO! Voc√™ subiu para a S√©rie D!"; }
            else if (rebaixadosDtoE.some(t => t.id === meuTime.id)) { resultadoFinal = "REBAIXAMENTO! Voc√™ caiu para a S√©rie E."; }
            else if (promovidosDtoC.some(t => t.id === meuTime.id)) { resultadoFinal = "PROMO√á√ÉO! Voc√™ subiu para a S√©rie C!"; }
            else if (rebaixadosCtoD.some(t => t.id === meuTime.id)) { resultadoFinal = "REBAIXAMENTO! Voc√™ caiu para a S√©rie D."; }
            else if (promovidosCtoB.some(t => t.id === meuTime.id)) { resultadoFinal = "PROMO√á√ÉO! Voc√™ subiu para a S√©rie B!"; }
            else if (rebaixadosBtoC.some(t => t.id === meuTime.id)) { resultadoFinal = "REBAIXamento! Voc√™ caiu para a S√©rie C."; }
            else if (promovidosBtoA.some(t => t.id === meuTime.id)) { resultadoFinal = "PROMO√á√ÉO! Voc√™ subiu para a S√©rie A!"; }
            else if (rebaixadosAtoB.some(t => t.id === meuTime.id)) { resultadoFinal = "REBAIXAMENTO! Voc√™ caiu para a S√©rie B."; }
            else { resultadoFinal = `Voc√™ permaneceu na S√©rie ${meuTime.divisao}.`; }
            
            meuTime.historico.push({ temporada: temporadaCount, divisao: divisaoAnterior, posicao: posicaoFinalAnterior, resultado: resultadoFinal });
            meuTime.atualizarPatrocinio(posicaoFinalAnterior);
            return { mensagem: `Posi√ß√£o Final: ${posicaoFinalAnterior}¬∫. ${resultadoFinal}`, campeao: campeao, logPlayoff: (divisaoAnterior === 'F' && playoffResult) ? playoffResult.log : null };
        }

        function encerrarTemporada() {
            const divAtual = gameManager.divisoes[meuTime.divisao];
            const rodadasMax = (divAtual.size - 1) * 2;
            if (rodadaCount < rodadasMax) return; 

            const resultadosDivisao = promoverRebaixar();
            let mensagemTemporada = `Fim da Temporada ${temporadaCount}! ${resultadosDivisao.mensagem}`;
            
            if (resultadosDivisao.campeao) {
                mensagemTemporada += ` CAMPE√ÉO DA S√âRIE ${meuTime.divisao}! üèÜ O trof√©u est√° na sua galeria!`;
            }

            if (meuTime.derrotas === 0) {
                const bonusInvicto = 50000 * (1 + (6 - ['A','B','C','D','E','F'].indexOf(meuTime.divisao)));
                meuTime.saldo += bonusInvicto;
                mensagemTemporada += ` | B√¥nus de Temporada Invicta: +$${bonusInvicto.toLocaleString('pt-BR')}!`;
            }

            if (resultadosDivisao.logPlayoff) {
                mostrarPlayoffModal(resultadosDivisao.logPlayoff);
            }

            const jogadoresEmprestados = meuTime.jogadores.filter(j => j.emprestado);
            if (jogadoresEmprestados.length > 0) {
                mensagemTemporada += ` | ${jogadoresEmprestados.length} jogadores retornaram de seus empr√©stimos.`;
                meuTime.jogadores = meuTime.jogadores.filter(j => !j.emprestado);
                meuTime.titulares = meuTime.titulares.filter(id => meuTime.getJogador(id));
            }

            Object.values(gameManager.divisoes).forEach((div, i) => div.media_forca_ia += (6 - i));
            meuTime.jogadores.forEach(j => j.envelhecer());
            
            const numJovens = 2 + Math.floor(meuTime.academia_nivel / 2);
            for (let i = 0; i < numJovens; i++) {
                const habMin = 40 + meuTime.academia_nivel * 2;
                const habMax = 55 + meuTime.academia_nivel * 2;
                const potMin = 80 + meuTime.academia_nivel;
                const potMax = 100;
                meuTime.jogadores.push(gerarJogador(habMin, habMax, potMin, potMax, 16, 18));
            }
            mensagemTemporada += ` | ${numJovens} jovens talentos da academia foram promovidos!`;

            rodadaCount = 0;
            temporadaCount++;
            
            Object.values(gameManager.divisoes).forEach(div => {
                div.times.forEach(t => { t.vitorias = t.empates = t.derrotas = t.pontos = t.gols_pro = t.gols_contra = 0; });
            });
            
            exibirMensagem(mensagemTemporada, "system");
            atualizarGraficos();
        }

        function jogarRodada() {
            document.getElementById('btn-match').disabled = true;
            document.getElementById('btn-train').disabled = true;

            const divAtual = gameManager.divisoes[meuTime.divisao];
            const rodadasMax = (divAtual.size - 1) * 2;
            if (rodadaCount >= rodadasMax) {
                encerrarTemporada();
                document.getElementById('btn-match').disabled = false;
                document.getElementById('btn-train').disabled = false;
                return;
            }
            rodadaCount++;
            let resultMessage = '';
            
            const precoIngressoBase = {'A': 2.0, 'B': 1.5, 'C': 0.75, 'D': 0.40, 'E': 0.25, 'F': 0.15}[meuTime.divisao] || 0.15;
            const fatorPressao = 1 - (pressaoTorcida / 200); // de 1.0 (0 pressao) a 0.5 (100 pressao)
            lastTicketIncome = Math.floor(meuTime.estadio_capacidade * precoIngressoBase * (Math.random() * 0.5 + 0.5) * fatorPressao);
            meuTime.saldo += lastTicketIncome;

            pendingMatchResult = { message: ``, type: 'info' };
            pendingMatchResult.message += ` | Ingressos: +$${lastTicketIncome.toLocaleString('pt-BR')}.`;

            if (meuTime.titulares.length < MAX_TITULARES) pendingMatchResult.message += ` AVISO: Time jogou com ${meuTime.titulares.length} titulares!`;
            
            const resultados = divAtual.rodada();
            let meuResultado = resultados.find(r => r.time1_id === meuTime.id || r.time2_id === meuTime.id);
            
            if (meuResultado) {
                 if (configuracoes.coletivaOpcional) {
                    mostrarColetivaDeImprensa(meuResultado);
                 } else {
                    const golsM = meuResultado.time1_id === meuTime.id ? meuResultado.gols1 : meuResultado.gols2;
                    const golsA = meuResultado.time1_id === meuTime.id ? meuResultado.gols2 : meuResultado.gols1;
                    const adversarioNome = meuResultado.time1_id === meuTime.id ? meuResultado.time2 : meuResultado.time1;
                    pendingMatchResult.tempData = { golsM, golsA, adversarioNome };
                    responderColetiva('neutro');
                 }
            } else {
                 pendingMatchResult.message = `Rodada ${rodadaCount} | Seu time folgou.` + pendingMatchResult.message;
                 finalizarJogadaRodada();
            }
        }
        
        function finalizarJogadaRodada() {
            lastFinanceCycleIncome = 0;
            const rodadasMax = (gameManager.divisoes[meuTime.divisao].size - 1) * 2;
            if (rodadaCount % RODADAS_PARA_PAGAMENTO === 0) {
                meuTime.receberPatrocinioESalarios();
                pendingMatchResult.message += ` | Patroc√≠nio e Sal√°rios pagos.`;
            }
            
            const moralPressao = Math.floor(pressaoTorcida / 20); // 0-5 penalty
            meuTime.jogadores.forEach(j => {
                j.moral = Math.max(0, j.moral - moralPressao);
            });
            if(moralPressao > 0) pendingMatchResult.message += ` | Moral afetado pela press√£o da torcida (-${moralPressao}).`;

            if (Math.random() < 0.25 && rodadaCount < rodadasMax) {
                const evento = eventosAleatorios[Math.floor(Math.random() * eventosAleatorios.length)];
                evento.efeito(meuTime);
                const feed = document.getElementById('news-feed');
                feed.innerHTML = `<p class="font-bold text-indigo-600">${evento.titulo}</p><p class="text-sm text-gray-600">${evento.desc}</p>`;
            } else {
                document.getElementById('news-feed').innerHTML = `<p class="text-gray-500">Nenhum evento importante na √∫ltima rodada.</p>`;
            }
            
            exibirMensagem(pendingMatchResult.message, pendingMatchResult.type);
            atualizarGraficos();

            document.getElementById('btn-match').disabled = false;
            document.getElementById('btn-train').disabled = false;

            if (rodadaCount === rodadasMax) setTimeout(encerrarTemporada, 500);
        }

        function mostrarColetivaDeImprensa(resultado) {
            const golsM = resultado.time1_id === meuTime.id ? resultado.gols1 : resultado.gols2;
            const golsA = resultado.time1_id === meuTime.id ? resultado.gols2 : resultado.gols1;
            const adversarioNome = resultado.time1_id === meuTime.id ? resultado.time2 : resultado.time1;
            
            let resultadoTexto = `${meuTime.nome} ${golsM} x ${golsA} ${adversarioNome}`;
            document.getElementById('press-conference-result').textContent = resultadoTexto;

            pendingMatchResult.tempData = { golsM, golsA, adversarioNome };
            document.getElementById('press-conference-modal').classList.remove('hidden');
        }

        function responderColetiva(resposta) {
            const { golsM, golsA, adversarioNome } = pendingMatchResult.tempData;
            const vitoria = golsM > golsA;
            const derrota = golsA > golsM;
            let moralChange = 0;
            
            const fatorMarketing = 1 - (meuTime.depto_marketing_nivel - 1) * 0.05;

            if (resposta === 'elogiar') {
                moralChange = vitoria ? 10 : 3;
                pressaoTorcida = Math.max(0, pressaoTorcida - 8 * (1/fatorMarketing));
                pendingMatchResult.message = `(Coletiva: "Estou orgulhoso da entrega do time hoje.")` + pendingMatchResult.message;
            } else if (resposta === 'criticar') {
                moralChange = derrota ? -10 : -3;
                pressaoTorcida = Math.min(100, pressaoTorcida + 12 * fatorMarketing);
                pendingMatchResult.message = `(Coletiva: "Precisamos melhorar muito, a atua√ß√£o foi abaixo.")` + pendingMatchResult.message;
            } else { // neutro
                moralChange = vitoria ? 2 : (derrota ? -2 : 0);
                if (vitoria) pressaoTorcida = Math.max(0, pressaoTorcida - (5 * (1/fatorMarketing)));
                else if (derrota) pressaoTorcida = Math.min(100, pressaoTorcida + (10 * fatorMarketing));
                else pressaoTorcida = Math.min(100, pressaoTorcida + (2 * fatorMarketing));

                if (configuracoes.coletivaOpcional) {
                    pendingMatchResult.message = `(Coletiva: "Analisaremos o jogo e seguiremos trabalhando.")` + pendingMatchResult.message;
                }
            }

            meuTime.jogadores.forEach(j => {
                j.moral = Math.max(0, Math.min(100, j.moral + moralChange));
            });

            meuTime.jogadores.forEach(j => {
                let mudancaPartida = 0;
                if(vitoria) mudancaPartida = meuTime.titulares.includes(j.id) ? 7 : 3;
                if(derrota) mudancaPartida = meuTime.titulares.includes(j.id) ? -7 : -3;
                j.moral = Math.max(0, Math.min(100, j.moral + mudancaPartida));
            });

            if (vitoria) {
                const bonus = meuTime.pagarBonusVitoria();
                pendingMatchResult.message += ` | B√¥nus Vit√≥ria: -$${bonus.toLocaleString('pt-BR')}.`;
                const titulares = meuTime.titulares.map(id => meuTime.getJogador(id)).filter(j => j && !j.lesionado);
                if(titulares.length > 0) {
                    const jogadorDaPartida = titulares[Math.floor(Math.random() * titulares.length)];
                    jogadorDaPartida.moral = Math.min(100, jogadorDaPartida.moral + 15);
                    pendingMatchResult.message += ` | ${jogadorDaPartida.nome} foi o Jogador da Partida (+15 Moral)!`;
                }
                pendingMatchResult.type = 'success';
            } else if (derrota) {
                pendingMatchResult.type = 'error';
            } else {
                pendingMatchResult.type = 'warning';
            }
            
            const resultadoTexto = `${meuTime.nome} ${golsM} x ${golsA} ${adversarioNome}`;
            pendingMatchResult.message = `Rodada ${rodadaCount} | ${resultadoTexto}` + pendingMatchResult.message;

            document.getElementById('press-conference-modal').classList.add('hidden');
            finalizarJogadaRodada();
        }


        // --- Fun√ß√µes de UI ---

        function exibirMensagem(msg, tipo) {
            const div = document.getElementById('match-result');
            const cores = {
                'success': 'bg-green-100 text-green-800', 'error': 'bg-red-100 text-red-800',
                'warning': 'bg-yellow-100 text-yellow-800', 'info': 'bg-blue-100 text-blue-800',
                'system': 'bg-indigo-500 text-white font-extrabold'
            };
            div.textContent = msg;
            div.className = `mt-4 p-3 rounded-lg text-center font-semibold ${cores[tipo] || cores['info']}`;
            div.style.display = 'block';
        }

        function atualizarGraficos() {
            if (!meuTime || !gameManager) return;
            const divAtual = gameManager.divisoes[meuTime.divisao];
            const rodadasMax = (divAtual.size - 1) * 2;
            document.getElementById('season-counter').textContent = temporadaCount;
            document.getElementById('rodada-counter').textContent = `${rodadaCount}/${rodadasMax}`;
            
            const divNameEl = document.getElementById('division-name');
            divNameEl.textContent = `S√©rie ${meuTime.divisao}`;
            const divColor = {'A': 'text-green-600', 'B': 'text-yellow-600', 'C': 'text-orange-500', 'D': 'text-red-500', 'E': 'text-gray-500', 'F': 'text-gray-400'}[meuTime.divisao];
            divNameEl.className = `font-bold ${divColor}`;

            document.getElementById('team-balance').textContent = `Saldo: $${meuTime.saldo.toLocaleString('pt-BR')}`;
            document.getElementById('team-sponsorship').textContent = `Patroc√≠nio (ciclo): $${meuTime.patrocinio_valor.toLocaleString('pt-BR')}`;
            document.getElementById('team-salary').textContent = `Folha Salarial: $${meuTime.calcularFolhaSalarial().toLocaleString('pt-BR')}`;
            document.getElementById('team-force').textContent = `For√ßa M√©dia (${meuTime.tatica}): ${meuTime.calcularForca().toFixed(1)}`;
            document.getElementById('elenco-size').textContent = meuTime.jogadores.length;
            
            const custoUpgrade = meuTime.estadio_nivel * 75000 * (1 + (meuTime.estadio_nivel / 5));
            document.getElementById('stadium-info').innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-gray-800">Est√°dio N√≠vel ${meuTime.estadio_nivel}</p>
                        <p class="text-sm text-gray-500">Capacidade: ${meuTime.estadio_capacidade.toLocaleString('pt-BR')}</p>
                    </div>
                    <button onclick="upgradeEstadio()" class="px-4 py-2 bg-blue-500 text-white text-sm font-semibold rounded-lg hover:bg-blue-600">
                        Melhorar ($${Math.floor(custoUpgrade).toLocaleString('pt-BR')})
                    </button>
                </div>`;

            const custoUpgradeAcademia = Math.floor(100000 * Math.pow(1.5, meuTime.academia_nivel - 1));
            document.getElementById('academia-info').innerHTML = `
                <div class="flex justify-between items-center">
                     <div>
                        <p class="font-semibold text-gray-800">Academia N√≠vel: ${meuTime.academia_nivel}</p>
                        <p class="text-sm text-gray-500">Gera melhores jovens.</p>
                    </div>
                    <button onclick="melhorarAcademia()" class="px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700">
                        Melhorar ($${custoUpgradeAcademia.toLocaleString('pt-BR')})
                    </button>
                </div>`;

            const custoUpgradeTreinamento = Math.floor(120000 * Math.pow(1.6, meuTime.centro_treinamento_nivel - 1));
            document.getElementById('treinamento-info').innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-gray-800">C.T. N√≠vel: ${meuTime.centro_treinamento_nivel}</p>
                        <p class="text-sm text-gray-500">Aumenta efic√°cia do treino.</p>
                    </div>
                    <button onclick="melhorarCentroTreinamento()" class="px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700">
                        Melhorar ($${custoUpgradeTreinamento.toLocaleString('pt-BR')})
                    </button>
                </div>`;
            
            const custoUpgradeMedico = Math.floor(150000 * Math.pow(1.5, meuTime.depto_medico_nivel - 1));
            document.getElementById('medico-info').innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-gray-800">D.M. N√≠vel: ${meuTime.depto_medico_nivel}</p>
                        <p class="text-sm text-gray-500">Reduz tempo de les√£o.</p>
                    </div>
                    <button onclick="melhorarDeptoMedico()" class="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700">
                        Melhorar ($${custoUpgradeMedico.toLocaleString('pt-BR')})
                    </button>
                </div>`;
            
            const custoUpgradeMarketing = Math.floor(80000 * Math.pow(1.7, meuTime.depto_marketing_nivel - 1));
            document.getElementById('marketing-info').innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-gray-800">Marketing N√≠vel: ${meuTime.depto_marketing_nivel}</p>
                        <p class="text-sm text-gray-500">Gerencia a press√£o da torcida.</p>
                    </div>
                    <button onclick="melhorarDeptoMarketing()" class="px-4 py-2 bg-yellow-500 text-white text-sm font-semibold rounded-lg hover:bg-yellow-600">
                        Melhorar ($${custoUpgradeMarketing.toLocaleString('pt-BR')})
                    </button>
                </div>`;

            // Atualizar barra de press√£o
            const pressureBar = document.getElementById('fan-pressure-bar');
            const pressureText = document.getElementById('fan-pressure-text');
            const pressureColor = pressaoTorcida > 75 ? 'bg-red-500' : pressaoTorcida > 50 ? 'bg-yellow-500' : 'bg-green-500';
            pressureBar.style.width = `${pressaoTorcida}%`;
            pressureBar.className = `stat-bar ${pressureColor}`;
            let pressureDesc = 'Calma';
            if (pressaoTorcida > 75) pressureDesc = 'F√∫riosa!';
            else if (pressaoTorcida > 50) pressureDesc = 'Insatisfeita';
            else if (pressaoTorcida > 25) pressureDesc = 'Apoiando';
            pressureText.textContent = pressureDesc;

            document.getElementById('income-tickets').textContent = `+$${lastTicketIncome.toLocaleString('pt-BR')}`;
            document.getElementById('income-finance-cycle').textContent = `${lastFinanceCycleIncome >= 0 ? '+' : ''}$${lastFinanceCycleIncome.toLocaleString('pt-BR')}`;
            
            const marketList = document.getElementById('transfer-market-list');
            marketList.innerHTML = mercadoJogadores.length === 0 ? '<p class="text-gray-500 text-center py-4">Mercado vazio.</p>' : '';
            mercadoJogadores.forEach((j, index) => {
                const custo = Math.floor(j.habilidade * 75 * (1 + j.idade / 50));
                const potencialColor = j.potencial > 90 ? 'text-green-700' : j.potencial > 80 ? 'text-yellow-700' : 'text-gray-700';
                marketList.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                            <p class="font-bold text-gray-900">${j.nome} <span class="text-xs font-normal text-gray-500">(${j.posicao})</span></p>
                            <p class="text-sm font-semibold text-gray-700">Hab: <span class="text-indigo-600">${j.habilidade}</span> | P: <span class="${potencialColor}">${j.potencial}</span> | I: ${j.idade}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-extrabold text-green-700">$${custo.toLocaleString('pt-BR')}</span>
                            <button onclick="contratarJogador(${index})" class="px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg hover:bg-green-600 transition">Contratar</button>
                        </div>
                    </div>`;
            });

            const loanMarketList = document.getElementById('loan-market-list');
            loanMarketList.innerHTML = mercadoEmprestimo.length === 0 ? '<p class="text-gray-500 text-center py-4">Ningu√©m dispon√≠vel.</p>' : '';
            mercadoEmprestimo.forEach((j, index) => {
                const custo = Math.floor(j.habilidade * 250 * (1 - (j.idade - 24) * 0.05));
                loanMarketList.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                            <p class="font-bold text-gray-900">${j.nome} <span class="text-xs font-normal text-gray-500">(${j.posicao})</span></p>
                            <p class="text-sm font-semibold text-gray-700">Hab: <span class="text-indigo-600">${j.habilidade}</span> | I: ${j.idade}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-extrabold text-blue-700">$${custo.toLocaleString('pt-BR')}</span>
                            <button onclick="emprestarJogador(${index})" class="px-4 py-2 bg-blue-500 text-white text-sm font-semibold rounded-lg hover:bg-blue-600 transition">Emprestar</button>
                        </div>
                    </div>`;
            });


            const classificacao = divAtual.getTabelaClassificacao();
            document.getElementById('league-title').textContent = `Classifica√ß√£o da ${divAtual.nome}`;
            let tabelaHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">#</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Time</th>
                <th class="px-2 py-2 text-xs font-bold text-gray-900 uppercase">P</th>
                <th class="px-2 py-2 text-xs font-medium text-gray-600 uppercase hidden sm:table-cell">V/E/D</th>
                <th class="px-2 py-2 text-xs font-medium text-gray-600 uppercase">SG</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            const playoffStart = 2, playoffEnd = 6;
            
            classificacao.forEach((time, index) => {
                const pos = index + 1;
                const isPromo = pos <= divAtual.promoteCount && divAtual.promoteCount > 0 && divAtual.nome !== "S√©rie F" || (divAtual.nome === "S√©rie F" && pos === 1);
                const isPlayoff = divAtual.nome === "S√©rie F" && pos >= playoffStart && pos <= playoffEnd;
                const isReleg = pos > (divAtual.size - divAtual.relegatCount) && divAtual.relegatCount > 0;
                
                let rowClasses = time.eh_jogador ? 'bg-indigo-100 font-bold' : '';
                if (isPromo) rowClasses += ' promotion'; 
                if (isPlayoff) rowClasses += ' playoff';
                if (isReleg) rowClasses += ' relegation';

                tabelaHTML += `<tr class="${rowClasses}"><td class="px-3 py-2 text-center font-extrabold">${pos}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${time.nome}</td>
                    <td class="px-2 py-2 text-center font-extrabold">${time.pontos}</td>
                    <td class="px-2 py-2 text-center hidden sm:table-cell">${time.vitorias}/${time.empates}/${time.derrotas}</td>
                    <td class="px-2 py-2 text-center">${time.gols_pro - time.gols_contra}</td></tr>`;
            });
            document.getElementById('league-table').innerHTML = tabelaHTML + '</tbody></table>';

            let legendHTML = '';
            const promoText = divAtual.promoteCount > 0 ? (divAtual.nome === "S√©rie F" ? "Acesso Direto" : "Zona de Promo√ß√£o") : 'Campe√£o';
            legendHTML += `<p><span class="inline-block w-3 h-3 bg-green-200 rounded-sm mr-1"></span> ${promoText}</p>`;
            if(divAtual.nome === "S√©rie F") {
                 legendHTML += `<p><span class="inline-block w-3 h-3 bg-yellow-200 rounded-sm mr-1"></span> Playoff de Acesso</p>`;
            }
            const relegText = divAtual.relegatCount > 0 ? `Zona de Rebaixamento` : 'N√£o h√° rebaixamento';
             if (divAtual.relegatCount > 0) {
                legendHTML += `<p><span class="inline-block w-3 h-3 bg-red-200 rounded-sm mr-1"></span> ${relegText}</p>`;
            }
            document.getElementById('league-legend').innerHTML = legendHTML;

            const statsBody = document.getElementById('player-stats-body');
            statsBody.innerHTML = '';
            meuTime.jogadores.sort((a,b) => meuTime.titulares.includes(b.id) - meuTime.titulares.includes(a.id) || b.habilidade - a.habilidade);
            meuTime.jogadores.forEach(j => {
                const isTitular = meuTime.titulares.includes(j.id);
                const moralColor = j.moral > 70 ? 'bg-green-500' : j.moral > 50 ? 'bg-yellow-500' : 'bg-red-500';
                const fadigaColor = j.fadiga < 30 ? 'bg-green-500' : j.fadiga < 60 ? 'bg-yellow-500' : 'bg-red-500';
                const statusText = j.lesionado ? `<span class="text-xs font-semibold inline-flex items-center px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">LES√ÉO (${j.dias_recuperacao} dias)</span>` : (j.emprestado ? `<span class="text-xs font-semibold inline-flex items-center px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800">Emprestado</span>`: `<span class="text-xs font-semibold inline-flex items-center px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Pronto</span>`);
                const healBtn = j.lesionado ? `<button onclick="curarJogadorImediatamente('${j.id}')" class="px-3 py-1 mt-1 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700">Curar ($${(j.habilidade*100).toLocaleString('pt-BR')})</button>` : '';
                const actionBtn = isTitular ? `<button onclick="toggleTitularidade('${j.id}', true)" class="px-3 py-1 bg-orange-500 text-white text-xs font-semibold rounded-lg hover:bg-orange-600">Para Reserva</button>` : `<button onclick="toggleTitularidade('${j.id}', false)" class="px-3 py-1 bg-indigo-500 text-white text-xs font-semibold rounded-lg hover:bg-indigo-600">Para Titular</button>`;
                
                const reputationMultiplier = { 'A': 1.0, 'B': 0.85, 'C': 0.65, 'D': 0.5, 'E': 0.40, 'F': 0.30 }[meuTime.divisao];
                const baseSellPrice = Math.floor(j.habilidade*15*(1+j.potencial/100)*(1-j.idade/50));
                const sellPrice = Math.floor(baseSellPrice * reputationMultiplier);

                statsBody.innerHTML += `<tr class="${isTitular ? 'bg-indigo-50 font-medium' : 'hover:bg-gray-50'}">
                        <td class="px-3 py-2"><p>${j.nome}</p><p class="text-xs text-gray-500">${j.posicao}</p></td>
                        <td class="px-3 py-2"><p class="text-lg font-bold text-indigo-700">${j.habilidade}</p><p class="text-xs text-gray-600">P: ${j.potencial} | I: ${j.idade}</p></td>
                        <td class="px-3 py-2">${isTitular ? `<span class="text-sm font-bold text-indigo-600">Titular</span>` : `<span class="text-sm text-gray-500">Reserva</span>`}<div class="mt-1">${statusText}</div>${healBtn}</td>
                        <td class="px-3 py-2"><p class="text-xs font-semibold">Fadiga:</p><div class="w-full bg-gray-200 rounded-full mb-1"><div class="${fadigaColor} stat-bar" style="width: ${j.fadiga}%;"></div></div><p class="text-xs font-semibold">Moral:</p><div class="w-full bg-gray-200 rounded-full"><div class="${moralColor} stat-bar" style="width: ${j.moral}%;"></div></div></td>
                        <td class="px-3 py-2 space-y-1">${actionBtn}<button onclick="venderJogador('${j.id}')" class="px-3 py-1 bg-yellow-500 text-white text-xs font-semibold rounded-lg hover:bg-yellow-600" ${j.emprestado ? 'disabled' : ''}>Vender ($${sellPrice.toLocaleString('pt-BR')})</button></td>
                    </tr>`;
            });
        }
        
        // --- Fun√ß√µes de Save/Load e Hist√≥rico ---
        function salvarJogo() {
            try {
                const dehydratedState = JSON.stringify({ 
                    meuTime, 
                    gameManager, 
                    rodadaCount, 
                    temporadaCount, 
                    mercadoJogadores, 
                    mercadoEmprestimo, 
                    lastTicketIncome, 
                    lastFinanceCycleIncome,
                    pressaoTorcida,
                    configuracoes
                });
                localStorage.setItem(SAVE_KEY, dehydratedState);
                exibirMensagem("Jogo salvo com sucesso!", "success");
            } catch (e) {
                console.error("Erro ao salvar o jogo:", e);
                exibirMensagem("Erro ao salvar. O estado do jogo pode ser muito grande.", "error");
            }
        }

        function carregarJogo() {
            const savedState = localStorage.getItem(SAVE_KEY);
            if (!savedState) {
                exibirMensagem(`Nenhum jogo salvo encontrado (${SAVE_KEY.split('_')[1]}).`, "error");
                return;
            }
            const loadedData = JSON.parse(savedState);
            
            const rehydrateObject = (source, target) => {
                for (const key in source) {
                    if (Object.prototype.hasOwnProperty.call(source, key)) {
                        target[key] = source[key];
                    }
                }
                return target;
            };

            const rehydrateJogador = pData => rehydrateObject(pData, new Jogador());
            const rehydrateTime = tData => {
                const time = rehydrateObject(tData, new Time());
                time.jogadores = time.jogadores.map(rehydrateJogador);
                time.centro_treinamento_nivel = time.centro_treinamento_nivel || 1;
                time.depto_medico_nivel = time.depto_medico_nivel || 1;
                time.depto_marketing_nivel = time.depto_marketing_nivel || 1;
                time.trofeus = time.trofeus || {};
                return time;
            };
            const rehydrateDivisao = dData => {
                const div = rehydrateObject(dData, new Divisao());
                div.times = div.times.map(rehydrateTime);
                return div;
            };

            meuTime = rehydrateTime(loadedData.meuTime);
            if (!loadedData.gameManager.divisoes.F) {
                initGame(); 
                exibirMensagem("Save incompat√≠vel com a nova vers√£o. Um novo jogo foi iniciado.", "warning");
                return;
            }

            gameManager = {
                meuTime: meuTime,
                divisoes: {
                    A: rehydrateDivisao(loadedData.gameManager.divisoes.A),
                    B: rehydrateDivisao(loadedData.gameManager.divisoes.B),
                    C: rehydrateDivisao(loadedData.gameManager.divisoes.C),
                    D: rehydrateDivisao(loadedData.gameManager.divisoes.D),
                    E: rehydrateDivisao(loadedData.gameManager.divisoes.E),
                    F: rehydrateDivisao(loadedData.gameManager.divisoes.F)
                }
            };
            
            rodadaCount = loadedData.rodadaCount;
            temporadaCount = loadedData.temporadaCount;
            mercadoJogadores = (loadedData.mercadoJogadores || []).map(rehydrateJogador);
            mercadoEmprestimo = (loadedData.mercadoEmprestimo || []).map(rehydrateJogador);
            lastTicketIncome = loadedData.lastTicketIncome || 0;
            lastFinanceCycleIncome = loadedData.lastFinanceCycleIncome || 0;
            pressaoTorcida = loadedData.pressaoTorcida || 20;
            configuracoes = loadedData.configuracoes || { coletivaOpcional: true };

            document.getElementById('toggle-press-conference').checked = configuracoes.coletivaOpcional;

            const currentDiv = gameManager.divisoes[meuTime.divisao];
            if(currentDiv) {
                const myTeamIndex = currentDiv.times.findIndex(t => t.id === meuTime.id);
                if(myTeamIndex !== -1) {
                    currentDiv.times[myTeamIndex] = meuTime;
                }
            }

            atualizarGraficos();
            exibirMensagem("Jogo carregado com sucesso!", "success");
        }
        
        function mostrarHistorico() {
            const content = document.getElementById('history-content');
            content.innerHTML = '';
            if (!meuTime.historico || meuTime.historico.length === 0) {
                content.innerHTML = '<p class="text-gray-500">Nenhuma temporada foi completada ainda.</p>';
            } else {
                let historyHTML = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2">Temporada</th><th class="px-4 py-2">Divis√£o</th><th class="px-4 py-2">Posi√ß√£o</th><th class="px-4 py-2">Resultado</th></tr></thead><tbody>';
                [...meuTime.historico].reverse().forEach(h => {
                    historyHTML += `<tr class="text-center"><td class="py-2">${h.temporada}</td><td>S√©rie ${h.divisao}</td><td>${h.posicao}¬∫</td><td class="font-semibold">${h.resultado}</td></tr>`;
                });
                content.innerHTML = historyHTML + '</tbody></table>';
            }
            document.getElementById('history-modal').classList.remove('hidden');
        }

        function fecharHistorico() { document.getElementById('history-modal').classList.add('hidden'); }

        function gerarTrofeuSVG(primaryColor, secondaryColor) {
            return `
                <svg class="w-24 h-24" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M30 90 H70 V80 H30 Z" fill="${secondaryColor}"/>
                    <path d="M40 80 H60 V70 H40 Z" fill="${secondaryColor}"/>
                    <path d="M50 70 A15 15 0 0 1 50 40 A15 15 0 0 1 50 70" fill="${primaryColor}"/>
                    <path d="M20 50 H35 V40 H20 Z" fill="${primaryColor}"/>
                    <path d="M80 50 H65 V40 H80 Z" fill="${primaryColor}"/>
                    <rect x="45" y="20" width="10" height="20" fill="${primaryColor}"/>
                    <circle cx="50" cy="15" r="10" fill="${primaryColor}"/>
                </svg>`;
        }

        function mostrarTrofeus() {
            const content = document.getElementById('trophy-content');
            content.innerHTML = '';
            const trofeus = meuTime.trofeus;
            const todasSeries = ['A', 'B', 'C', 'D', 'E', 'F'];
            const cores = {
                A: ['#FFD700', '#FFA500'], // Gold
                B: ['#C0C0C0', '#A9A9A9'], // Silver
                C: ['#CD7F32', '#A0522D'], // Bronze
                D: ['#4682B4', '#5F9EA0'], // Steel Blue
                E: ['#808080', '#696969'], // Gray
                F: ['#A0522D', '#8B4513'] // Sienna/SaddleBrown
            };

            let trofeusHTML = '';
            todasSeries.forEach(serie => {
                const titulos = trofeus[serie];
                if (titulos && titulos.length > 0) {
                    const [cor1, cor2] = cores[serie];
                    trofeusHTML += `
                        <div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg">
                            ${gerarTrofeuSVG(cor1, cor2)}
                            <p class="mt-2 text-xl font-bold text-gray-800">S√©rie ${serie}</p>
                            <p class="text-lg font-semibold text-indigo-600">x ${titulos.length}</p>
                            <p class="text-xs text-gray-500 mt-1">Temporada(s): ${titulos.join(', ')}</p>
                        </div>
                    `;
                }
            });

            if (trofeusHTML === '') {
                 content.innerHTML = '<p class="text-gray-500 col-span-full text-center">Sua sala de trof√©us est√° vazia. Ganhe um campeonato para come√ßar!</p>';
            } else {
                content.innerHTML = trofeusHTML;
            }
            document.getElementById('trophy-modal').classList.remove('hidden');
        }

        function fecharTrofeus() { document.getElementById('trophy-modal').classList.add('hidden'); }

        function mostrarPlayoffModal(logHTML) {
            document.getElementById('playoff-content').innerHTML = logHTML;
            document.getElementById('playoff-modal').classList.remove('hidden');
        }

        function fecharPlayoffModal() { document.getElementById('playoff-modal').classList.add('hidden'); }

        function toggleColetiva(isChecked) {
            configuracoes.coletivaOpcional = isChecked;
        }

        window.onload = initGame;
    </script>
</body>
</html>

